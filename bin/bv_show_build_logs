#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import print_function
import os, sys, re
import optparse
import subprocess
from PyQt4 import QtCore, QtGui
if sys.version_info[0] >= 3:
    xrange = range

logfiles = ['/home/a-sac-ns-brainvisa/builds.log']
todel_files = []
ssh_user = ''

parser = optparse.OptionParser('Display BrainVisa build logs in a GUI')
parser.add_option('-i', '--input', dest='logfile', action='append',
    help='input log file(s) [default: %s]' % str(logfiles))
parser.add_option('-u', '--user', dest='user',
    help='user for ssh access. default: not specified, use current one')

options, args = parser.parse_args(sys.argv)
logfiles = options.logfile

if options.user:
    ssh_user = options.user + '@'

if not os.path.exists(logfiles[0]):
    try:
        neurospin_log = '/tmp/build-neurospin.log'
        print('retreiving neurospin log')
        subprocess.check_call(['scp', '%sis208611:%s'
                               % (ssh_user, logfiles[0]),
                              neurospin_log])
        todel_files.append(neurospin_log)
        logfiles = [neurospin_log]
    except:
        pass

try:
    michael_log = '/tmp/build-michael.log'
    print('retreiving michael log')
    subprocess.check_call(['scp',
                           '%smichael:/home/i2bm-research/builds.log'
                              % ssh_user,
                           michael_log])
    todel_files = [michael_log]
    logfiles.append(michael_log)
except:
    pass

app = QtGui.QApplication(sys.argv)
mw = QtGui.QMainWindow(None)
mw.setWindowTitle('BrainVisa Builds logs')
tv = QtGui.QTableWidget(mw)
mw.setCentralWidget(tv)
tv.setColumnCount(6)
tv.setColumnWidth(0, 200)
tv.setColumnWidth(1, 200)
tv.setColumnWidth(3, 100)
tv.setColumnWidth(4, 100)
tv.setHorizontalHeaderLabels(['start date', 'stop date', 'step', 'status',
                              'system', 'directory'])
tv.setSortingEnabled(True)
r = re.compile('([^ ]+) - build started ([^,]+), stopped (.+) on ([^,]+)')
r2 = re.compile('^([^ ]+) +step ([^ :]+): ([^ ,]+), started: ([^,]+), stopped: (.+) on (.+)$')
items = []
for logfile in logfiles:
    for i, l in enumerate(open(logfile).readlines()):
        m = r.match(l)
        new_style = False
        if not m or len(m.groups()) != 4:
            m = r2.match(l) # new style
            if not m or len(m.groups()) != 6:
                raise SyntaxError('in file %s, line %d :\n%s'
                                  % (logfile, i, l))
            new_style = True
        if new_style:
            items.append((m.group(4), m.group(5), m.group(2), m.group(1),
                          m.group(6), m.group(3)))
        else:
            items.append((m.group(2), m.group(3), 'all', m.group(1),
                          m.group(4), ''))
    tv.setRowCount(len(items))
    for i in xrange(len(items)):
        for j in xrange(len(items[-i-1])):
            tv.setItem(i, j, QtGui.QTableWidgetItem(items[-i-1][j]))
        if items[-i-1][3] in ('Error', 'FAILED'):
            tv.item(i, 3).setBackground( QtGui.QBrush( \
                QtGui.QColor(255, 192, 192)))
        else:
            tv.item(i, 3).setBackground( QtGui.QBrush( \
                QtGui.QColor(192, 255, 192)))

tv.sortItems(0, QtCore.Qt.DescendingOrder)
# tv.sortByColumn( 0, QtCore.Qt.DescendingOrder )
tv.resizeColumnsToContents()
p = mw.menuBar().addMenu('File')
p.addAction(QtGui.QIcon(), '&Quit', app.quit, QtGui.QKeySequence.Quit)
mw.resize(800, 800)
mw.show()
app.exec_()

for file in todel_files:
    os.unlink(file)
